<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Showcase - Lars K√∂lbel Veranstaltungstechnik</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap');
        :root { --bg-dark: #080a0f; --card-bg: #12151c; --text-main: #f8fafc; --border-color: #1e293b; --accent: #3b82f6; }
        body { font-family: 'Outfit', sans-serif; background-color: var(--bg-dark); color: var(--text-main); line-height: 1.5; }
        .bento-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 24px; padding: 2rem; }
        .hero-overlay { background: linear-gradient(to top, var(--bg-dark) 0%, rgba(8, 10, 15, 0.4) 60%, rgba(8, 10, 15, 0) 100%); }
        .date-pill { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.2); padding: 0.5rem 1.25rem; border-radius: 9999px; font-weight: 600; font-size: 0.85rem; color: #fff; }
        .date-row-card { background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border-color); border-radius: 16px; padding: 1.25rem; transition: all 0.2s ease; cursor: pointer; }
        .date-row-card:hover { background: rgba(255, 255, 255, 0.06); border-color: var(--accent); transform: translateX(4px); }
        #map { height: 100%; min-height: 280px; border-radius: 16px; filter: invert(90%) hue-rotate(180deg) brightness(0.7) contrast(1.1); }
        .action-button { background: var(--text-main); color: var(--bg-dark); padding: 0.8rem 1.5rem; border-radius: 12px; font-weight: 700; text-transform: uppercase; font-size: 0.75rem; display: inline-block; transition: all 0.2s; border: none; cursor: pointer; text-decoration: none; text-align: center; }
        .action-button:hover:not(.disabled) { opacity: 0.85; transform: translateY(-2px); }
        .disabled { opacity: 0.2; cursor: not-allowed; }
        .glow-text { text-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
        .badge-warning { background: #f59e0b; color: #000; font-size: 10px; font-weight: 800; padding: 2px 8px; border-radius: 4px; text-transform: uppercase; }
        .preserve-breaks { white-space: pre-line; }
        .content-link { color: var(--accent); text-decoration: underline; text-underline-offset: 4px; font-weight: 600; transition: opacity 0.2s; }
        .content-link:hover { opacity: 0.7; }
        .info-label { display: flex; align-items: center; gap: 12px; padding: 10px 14px; border-radius: 12px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); font-size: 0.85rem; }
        .warn-label { border-color: rgba(239, 68, 68, 0.2); background: rgba(239, 68, 68, 0.05); color: #fca5a5; }
    </style>
</head>
<body class="pb-24">

<header id="page-header" class="relative w-full h-[70vh] flex items-end overflow-hidden">
    <img id="main-image" class="absolute inset-0 w-full h-full object-cover" src="" alt="">
    <div class="absolute inset-0 hero-overlay"></div>
    <div class="relative max-w-7xl mx-auto w-full px-6 pb-20">
        <div id="event-dates-summary" class="flex flex-wrap gap-3 mb-6"></div>
        <h1 id="event-title" class="text-5xl md:text-8xl font-extrabold tracking-tight leading-[0.9] mb-4 text-white">Lade Event...</h1>
        <div id="preview-header-info" class="hidden mt-8">
            <div class="inline-block px-4 py-1 rounded-full bg-blue-500/20 border border-blue-500/30 text-blue-400 text-xs font-bold uppercase tracking-widest">In K√ºrze verf√ºgbar</div>
        </div>
    </div>
</header>

<main id="main-content" class="max-w-7xl mx-auto px-6 -mt-12 relative z-10">
    <div id="error-box" class="hidden bento-card border-red-500/40 text-center py-20 bg-gradient-to-b from-red-500/5 to-transparent">
        <div class="text-6xl mb-6">‚ö†Ô∏è</div>
        <h2 class="text-4xl font-black text-white mb-4">Event nicht gefunden</h2>
        <p id="error-message" class="text-slate-400 text-lg max-w-md mx-auto mb-10">Das von dir angeforderte Event existiert nicht oder wurde bereits entfernt.</p>
        <a href="/" class="action-button">Zur Startseite</a>
    </div>

    <section id="preview-countdown-card" class="hidden bento-card border-blue-500/30 mb-12 text-center py-12">
        <p class="text-slate-500 text-xs uppercase tracking-[0.3em] mb-4">Ver√∂ffentlichung in</p>
        <div id="countdown" class="text-5xl md:text-7xl font-black text-white tracking-tighter glow-text font-mono">--:--:--:--</div>
    </section>

    <div id="event-details-grid" class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        <div class="lg:col-span-8 space-y-8">
            <section id="artist-card" class="bento-card flex flex-col md:flex-row gap-8 items-center hidden">
                <div id="artist-img-wrapper" class="w-40 h-40 md:w-52 md:h-52 rounded-2xl overflow-hidden flex-shrink-0 border border-white/10 shadow-2xl">
                    <img id="artist-image" class="w-full h-full object-cover" src="" alt="">
                </div>
                <div class="flex-1 text-center md:text-left">
                    <span class="text-blue-500 font-bold uppercase tracking-widest text-[10px] mb-2 block">K√ºnstler</span>
                    <h2 id="artist-name" class="text-4xl md:text-5xl font-extrabold text-white"></h2>
                </div>
            </section>
            <section id="desc-card" class="bento-card hidden">
                <h3 class="text-slate-500 font-bold text-[10px] uppercase tracking-widest mb-4">Details</h3>
                <p id="main-description" class="text-xl text-slate-300 leading-relaxed font-light preserve-breaks"></p>
            </section>
            <div id="extra-sections" class="space-y-8"></div>
        </div>

        <div class="lg:col-span-4 space-y-8">
            <section id="dates-card" class="bento-card hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-[0.2em]">Auff√ºhrungen</h3>
                    <span class="text-[10px] text-slate-600 font-medium italic">Klick f√ºr Kalender</span>
                </div>
                <div id="dates-list" class="space-y-3"></div>
            </section>

            <section id="info-warning-card" class="bento-card hidden">
                <h3 class="text-xs font-bold mb-6 text-slate-500 uppercase tracking-[0.2em]">Info & Hinweise</h3>
                <div id="info-warning-list" class="space-y-3 mb-6"></div>
                <a href="/events/info/tags" class="flex items-center justify-between group p-3 rounded-xl border border-slate-800 hover:border-blue-500/50 transition-all">
                    <span class="text-[10px] font-bold uppercase tracking-widest text-slate-400 group-hover:text-blue-400 transition-colors">Weitere Informationen</span>
                    <span class="text-slate-600 group-hover:text-blue-400 transition-colors text-xs">‚ûî</span>
                </a>
            </section>

            <section id="location-container" class="bento-card hidden">
                <h3 class="text-xs font-bold mb-6 text-slate-500 uppercase tracking-[0.2em]">Veranstaltungsort</h3>
                <div class="mb-6">
                    <p id="location-name" class="font-bold text-lg text-white"></p>
                    <p id="location-address" class="text-slate-500 text-sm mt-1"></p>
                </div>
                <div id="map-wrapper" class="h-48 mb-6 hidden overflow-hidden rounded-xl border border-slate-800"><div id="map"></div></div>
                <button id="google-maps-btn" class="w-full text-center border border-slate-800 py-3 rounded-xl text-xs font-bold uppercase tracking-widest hover:bg-white hover:text-black transition-all">In Maps √∂ffnen</button>
            </section>
        </div>

        <div class="lg:col-span-12">
            <section id="tickets-container" class="bento-card bg-gradient-to-br from-slate-900 to-black hidden">
                <h2 class="text-4xl font-extrabold text-white tracking-tight mb-8">Karten w√§hlen</h2>
                <div id="ticket-status-msg" class="hidden p-8 rounded-2xl bg-blue-500/10 border border-blue-500/20 text-center mb-6">
                    <p id="ticket-msg-text" class="text-blue-400 font-semibold"></p>
                </div>
                <div id="tickets-list" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
            </section>
        </div>
    </div>
</main>

<footer class="mt-32 py-16 text-center border-t border-slate-900">
    <p class="text-slate-600 text-[10px] tracking-[0.4em] uppercase">¬© 2026 - Lars K√∂lbel Veranstaltungstechnik</p>
</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    function linkify(text) {
        if (!text) return "";
        const urlPattern = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
        return text.replace(urlPattern, '<a href="$1" target="_blank" class="content-link">$1</a>');
    }

    function redirectToCalendar(title, dateStr, startStr, endStr, location) {
        const dateParts = dateStr.split('.');
        const dateISO = `${dateParts[2]}${dateParts[1]}${dateParts[0]}`;
        const cleanStart = startStr.replace(':', '');
        const cleanEnd = endStr.replace(':', '');
        const url = `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${dateISO}T${cleanStart}00/${dateISO}T${cleanEnd}00&location=${encodeURIComponent(location)}&sf=true&output=xml`;
        window.open(url, '_blank');
    }

    function initCountdown(targetDateStr) {
        const countdownEl = document.getElementById('countdown');
        const targetDate = new Date(targetDateStr).getTime();
        if (isNaN(targetDate)) return;

        const timer = setInterval(() => {
            const now = new Date().getTime();
            const distance = targetDate - now;
            if (distance < 0) {
                clearInterval(timer);
                countdownEl.innerText = "JETZT VERF√úGBAR";
                setTimeout(() => location.reload(), 2000);
                return;
            }
            const d = Math.floor(distance / (1000 * 60 * 60 * 24));
            const h = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((distance % (1000 * 60)) / 1000);
            countdownEl.innerText = `${d}d ${h.toString().padStart(2, '0')}h ${m.toString().padStart(2, '0')}m ${s.toString().padStart(2, '0')}s`;
        }, 1000);
    }

    async function fetchWarningsAndInfo(eventId) {
        try {
            const response = await fetch('/api/events/warnings_and_info', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: eventId })
            });
            if (!response.ok) return;
            const data = await response.json();
            const parsedData = (typeof data === 'string') ? JSON.parse(data) : data;
            renderWarningsAndInfo(parsedData);
        } catch (e) { console.error("Info API Error:", e); }
    }

    function renderWarningsAndInfo(data) {
        const container = document.getElementById('info-warning-card');
        const list = document.getElementById('info-warning-list');
        list.innerHTML = "";
        let hasContent = false;

        const entries = [
            { condition: data.warn_strobe_lights, text: "Stroboskop-Effekte", icon: "‚ö°", isWarn: true },
            { condition: data.warn_haze_machines, text: "Nebel / Haze im Einsatz", icon: "üí®", isWarn: true },
            { condition: data.warn_loud_sounds, text: "Hoher Schalldruckpegel", icon: "üîä", isWarn: true },
            { condition: data.warn_other, text: data.warn_other, icon: "‚ö†Ô∏è", isWarn: true },
            { condition: data.info_is_wheelchair_accessible, text: "Barrierefrei", icon: "‚ôø", isWarn: false },
            { condition: data.info_has_parking, text: "Parkpl√§tze vorhanden", icon: "üöó", isWarn: false },
            { condition: data.info_has_public_transportation, text: "√ñPNV Anbindung", icon: "üöå", isWarn: false },
            { condition: data.info_has_food_and_drinks, text: "Gastronomie vor Ort", icon: "üçπ", isWarn: false },
            { condition: data.info_other, text: data.info_other, icon: "‚ÑπÔ∏è", isWarn: false }
        ];

        entries.forEach(entry => {
            if (entry.condition === true || entry.condition === "true" || (typeof entry.condition === 'string' && entry.condition.length > 1)) {
                hasContent = true;
                const div = document.createElement('div');
                div.className = `info-label ${entry.isWarn ? 'warn-label' : ''}`;
                div.innerHTML = `<span>${entry.icon}</span><span class="font-medium">${entry.text}</span>`;
                list.appendChild(div);
            }
        });

        if (hasContent) container.classList.remove('hidden');
    }

    async function fetchEventData() {
        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('event');
        if (!eventId) return;

        fetchWarningsAndInfo(eventId);

        try {
            const response = await fetch('/api/events', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ event_id: eventId })
            });
            const data = await response.json();

            if (!response.ok) {
                document.getElementById('event-details-grid').classList.add('hidden');
                document.getElementById('event-title').innerText = "Fehler";
                document.getElementById('error-box').classList.remove('hidden');
                document.getElementById('error-message').innerText = data.message || "Event konnte nicht geladen werden.";
                return;
            }

            const previewVal = data.is_preview;
            const isPreviewActive = (previewVal !== false && previewVal !== "false");

            if (isPreviewActive) {
                document.getElementById('event-details-grid').classList.add('hidden');
                document.getElementById('preview-header-info').classList.remove('hidden');
                document.getElementById('preview-countdown-card').classList.remove('hidden');
                const dateToUse = (typeof previewVal === 'string' && previewVal.length > 5) ? previewVal : data.release_date_and_time;
                if (dateToUse) initCountdown(dateToUse);
            }

            document.getElementById('event-title').innerText = data.title;
            if (data.main_image && data.main_image.length > 50) {
                const imgPrefix = data.main_image.startsWith('/') ? '' : 'data:image/jpeg;base64,';
                document.getElementById('main-image').src = data.main_image;
            }
            renderContent(data);
        } catch (e) { console.error(e); }
    }

    function renderContent(data) {
        if (data.dates && data.dates.length > 0) {
            const summary = document.getElementById('event-dates-summary');
            const list = document.getElementById('dates-list');
            data.dates.forEach(d => {
                const pill = document.createElement('div');
                pill.className = "date-pill"; pill.innerText = `${d.date} ‚Ä¢ ${d.start} Uhr`; summary.appendChild(pill);
                const item = document.createElement('div');
                item.className = "date-row-card flex justify-between items-center group";
                item.onclick = () => redirectToCalendar(data.title, d.date, d.start, d.end, data.location ? data.location.location_name : '');
                item.innerHTML = `<div><span class="text-white font-bold group-hover:text-blue-400 transition-colors">${d.date}</span><div class="flex items-center gap-2 mt-1"><span class="text-[10px] text-slate-500 uppercase tracking-widest">${d.start} - ${d.end} Uhr</span>${d.duration ? `<span class="text-[9px] px-1.5 py-0.5 rounded bg-white/5 text-slate-400 border border-white/5">Dauer: ${d.duration}</span>` : ''}${d.entrance ? `<span class="text-[9px] px-1.5 py-0.5 rounded bg-blue-500/10 text-blue-400 border border-blue-500/10 ml-2 font-bold uppercase">Einlass: ${d.entrance}</span>` : ''}</div></div><div class="h-8 w-8 rounded-full border border-slate-800 flex items-center justify-center text-xs group-hover:border-blue-500/50 transition-all">üìÖ</div>`;
                list.appendChild(item);
            });
            document.getElementById('dates-card').classList.remove('hidden');
        }

        if (data.artist) {
            document.getElementById('artist-card').classList.remove('hidden');
            document.getElementById('artist-name').innerText = data.artist.name;
            if (data.artist.image && data.artist.image.length > 50) document.getElementById('artist-image').src = `data:image/jpeg;base64,${data.artist.image}`;
            else document.getElementById('artist-img-wrapper').classList.add('hidden');
        }

        if (data.main_description) {
            document.getElementById('desc-card').classList.remove('hidden');
            document.getElementById('main-description').innerHTML = linkify(data.main_description);
        }

        if (data.sections && data.sections.show_sections) {
            const container = document.getElementById('extra-sections');
            container.innerHTML = "";
            data.sections.sections.forEach(s => {
                const div = document.createElement('div');
                div.className = "bento-card overflow-hidden !p-0";
                div.innerHTML = `
                        ${s.image && s.image.length > 50 ? `<img src="${s.image}" class="w-full h-80 object-cover opacity-90">` : ''}
                        <div class="p-8">
                            ${s.title ? `<h3 class="text-2xl font-extrabold mb-4 text-white">${s.title}</h3>` : ''}
                            <p class="text-slate-400 font-light leading-relaxed preserve-breaks">${linkify(s.text)}</p>
                        </div>`;
                container.appendChild(div);
            });
        }

        if (data.location) {
            document.getElementById('location-container').classList.remove('hidden');
            document.getElementById('location-name').innerText = data.location.location_name;
            document.getElementById('location-address').innerText = data.location.location_address;

            // KORREKTUR HIER: Template Literal Syntax korrigiert ($ statt 0)
            document.getElementById('google-maps-btn').onclick = () => {
                const query = encodeURIComponent(`${data.location.location_name} ${data.location.location_address}`);
                window.open(`https://www.google.com/maps/search/?api=1&query=${query}`, '_blank');
            };

            const coordsRaw = data.location.loacation_coordinates || data.location.location_coordinates;
            if (data.location.show_location_on_map && coordsRaw) {
                document.getElementById('map-wrapper').classList.remove('hidden');
                const coords = coordsRaw.split('|').map(Number);
                const map = L.map('map', {zoomControl:false}).setView(coords, 14);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
                L.marker(coords).addTo(map);
            }
        }

        if (data.ticket_redirects && data.ticket_redirects.show_ticket_redirects) {
            document.getElementById('tickets-container').classList.remove('hidden');
            const tList = document.getElementById('tickets-list');
            const isOpen = data.ticket_redirects.is_open;
            if (isOpen === true || isOpen === "true") {
                data.ticket_redirects.redirects.forEach(t => {
                    const isFew = t.ticket_fuew_left === true || t.ticket_few_left === true;
                    const div = document.createElement('div');
                    div.className = "flex items-center justify-between p-6 md:p-8 rounded-3xl bg-slate-800/30 border border-slate-800 hover:border-blue-500/30 transition-all";
                    div.innerHTML = `
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <p class="text-[9px] uppercase tracking-[0.2em] text-blue-500 font-bold">${t.ticket_name}</p>
                                    ${isFew ? `<span class="badge-warning">Fast ausverkauft</span>` : ''}
                                </div>
                                <h4 class="font-bold text-lg text-white">${t.ticket_location}</h4>
                                <div class="flex items-baseline gap-3 mt-4">
                                    <p class="text-3xl font-bold text-white">${t.ticket_price}</p>
                                    ${t.ticket_available_amount ? `<p class="text-[10px] text-slate-500 uppercase tracking-widest font-bold">Noch ${t.ticket_available_amount} verf√ºgbar</p>` : ''}
                                </div>
                            </div>
                            <div class="text-right">
                                <a href="${t.ticket_href}" class="action-button ${t.ticket_soled_out ? 'disabled' : ''}">${t.ticket_soled_out ? 'Sold Out' : 'W√§hlen'}</a>
                            </div>`;
                    tList.appendChild(div);
                });
            } else {
                document.getElementById('ticket-status-msg').classList.remove('hidden');
                document.getElementById('ticket-msg-text').innerText = (isOpen === false || isOpen === "false") ? "Ticketverkauf startet bald." : isOpen;
            }
        }
    }
    window.onload = fetchEventData;
</script>
</body>
</html>